<!-- 1. Состояние загрузки -->
@if (isLoading()) {
<p>Загрузка карты требований...</p>
}

<!-- 2. Состояние ошибки -->
@if (error()) {
<div class="error-message">
  <strong>Ошибка:</strong> {{ error() }}
</div>
}

<!-- 3. Успешная загрузка -->
@if (site(); as currentSite) {
<h2>Карта требований</h2>
<h3>Площадка: {{ currentSite.name }} ({{ currentSite.address }})</h3>

<div class="table-container">
  <table class="req-table">
    <thead>
      <tr>
        <th>Требование</th>
        <th>Основание</th>
        <th>Риски (Штраф)</th>
        <th>Статус</th>
        <th>Срок выполнения</th>
        <th>Ответственный</th>
        <!-- (1) --- ДОБАВЛЕНА КОЛОНКА "ДЕЙСТВИЯ" --- -->
        @if (authService.hasRole('Admin')) {
        <th>Действия</th>
        }
      </tr>
    </thead>
    <tbody>
      @for (req of currentSite.requirements; track req.id) {
      <tr>
        <td>{{ req.title }}</td>
        <td>{{ req.basis }}</td>
        <td class="risk-cell">{{ req.penaltyRisk ?? 'N/A' }}</td>
        <td [class]="'status-' + RequirementStatus[req.status].toLowerCase()">
          {{ getStatusText(req.status) }}
        </td>
        <td>{{ req.deadline | date : 'dd.MM.yyyy' }}</td>
        <td>{{ req.responsiblePerson }}</td>

        <!-- (2) --- ДОБАВЛЕНА КНОПКА "РЕДАКТИРОВАТЬ" --- -->
        @if (authService.hasRole('Admin')) {
        <td class="actions">
          <button class="action-btn edit" (click)="onEdit(req)">
            Редактировать
          </button>
        </td>
        }
      </tr>
      } @empty {
      <tr>
        <!-- (3) --- ОБНОВЛЕН Colspan --- -->
        <td [attr.colspan]="authService.hasRole('Admin') ? 7 : 6">
          Для данной площадки не было сгенерировано ни одного требования.
        </td>
      </tr>
      }
    </tbody>
  </table>
</div>
}

@if (siteIdSignal() > 0) {
<h2 class="artifacts-title">Артефакты / Хранилище</h2>
<app-artifact-manager [siteId]="siteIdSignal()"></app-artifact-manager>
}

@if (siteIdSignal() > 0) {
<h2 class="financials-title">Договора / Счета / Акты</h2>
<app-financial-document-list [siteId]="siteIdSignal()"></app-financial-document-list>
}

<!-- (4) --- ДОБАВЛЕНО МОДАЛЬНОЕ ОКНО --- -->
@if (isModalOpen()) {
<app-edit-requirement-modal [requirement]="selectedRequirement()" (save)="onSaveRequirement($event)"
  (close)="onCloseModal()" />
}
